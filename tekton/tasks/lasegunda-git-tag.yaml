apiVersion: tekton.dev/v1beta1
kind: ClusterTask
metadata:
  name: test-lasegunda-git-clone
  labels:
    owner: lasegunda
spec:
  params:
    - description: Name of application to deploy in openshift
      name: project
      type: string
  steps:
    - image: docker.io/alpine/git:v2.26.2
      name: git-clone
      resources: {}
      script: >
        PROJECT=$(parmas.project)

        cd $PROJECT

        echo "Making new version tag"
        ACTUAL_VERSION=$(grep -oPm1 "(?<=<version>)[^<]+" pom.xml)

        MAYOR="$(echo $ACTUAL_VERSION | cut -d'.' -f1)"
        MINOR="$(echo $ACTUAL_VERSION | cut -d'.' -f2)"
        PATCH="$(echo $ACTUAL_VERSION | cut -d'.' -f3)"

        NEW_VERSION=$MAYOR.$((MINOR + 1)).$PATCH
        echo "From $ACTUAL_VERSION to $NEW_VERSION"

        echo "Changing new version in POM"
        sed -i "s/<version>$ACTUAL_VERSION/<version>$NEW_VERSION/g" pom.xml

        echo "Pushing new version tag"
        git add .
        git commit -m "New version $NEW_VERSION"
        git push origin
        git tag $NEW_VERSION
        git push origin --tags

      workingDir: $(workspaces.workspace.path)
  workspaces:
    - description: Workspace to clone and work in the project
      name: workspace
    - description: Secret with all credententials needed
      name: secret
